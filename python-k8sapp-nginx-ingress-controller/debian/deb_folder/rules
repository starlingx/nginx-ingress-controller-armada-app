#!/usr/bin/make -f
# export DH_VERBOSE = 1

export APP_NAME=nginx-ingress-controller
export PBR_VERSION=1.0.0
export PYBUILD_NAME=k8sapp_nginx_ingress_controller
export ROOT=debian/tmp

%:
	dh $@ --with=python3 --buildsystem=pybuild

override_dh_auto_install:
	python3 setup.py install --install-layout=deb --root $(ROOT)
	rm -rf $(ROOT)/usr/lib/python3/dist-packages/k8sapp_nginx_ingress_controller/__pycache__
	rm -rf $(ROOT)/usr/lib/python3/dist-packages/k8sapp_nginx_ingress_controller/common/__pycache__
	rm -rf $(ROOT)/usr/lib/python3/dist-packages/k8sapp_nginx_ingress_controller/common/__pycache__
	rm -rf $(ROOT)/usr/lib/python3/dist-packages/k8sapp_nginx_ingress_controller/lifecycle/__pycache__
	rm -rf $(ROOT)/usr/lib/python3/dist-packages/k8sapp_nginx_ingress_controller/lifecycle/__pycache__
	rm -rf $(ROOT)/usr/lib/python3/dist-packages/k8sapp_nginx_ingress_controller/tests/__pycache__
	rm -rf $(ROOT)/usr/lib/python3/dist-packages/k8sapp_nginx_ingress_controller/tests/__pycache__
	python3 setup.py bdist_wheel \
		--universal \
		-d $(ROOT)/plugins/$(APP_NAME)

override_dh_python3:
	dh_python3 --shebang=/usr/bin/python3

ifeq (,$(findstring nocheck, $(DEB_BUILD_OPTIONS)))
override_dh_auto_test:
        # (tbogue) FIXME
        PYTHONDIR=$(CURDIR) stestr run || true
endif
